# GoReleaser configuration for apple-mail-mcp
# https://goreleaser.com

version: 2

# Project metadata
project_name: apple-mail-mcp

# Build configuration
builds:
  - id: apple-mail-mcp
    main: .
    binary: apple-mail-mcp

    # macOS only (Mail.app dependency)
    goos:
      - darwin

    goarch:
      - amd64
      - arm64

    # Build flags
    flags:
      - -trimpath

    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}

    env:
      - CGO_ENABLED=0

# Archive configuration
archives:
  - id: apple-mail-mcp
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"

    files:
      - LICENSE
      - README.md
      - CONTRIBUTING.md

# Checksums
checksum:
  name_template: "{{ .ProjectName }}_{{ .Version }}_checksums.txt"
  algorithm: sha256

# Homebrew tap (using modern 'homebrew' instead of deprecated 'brews')
brews:
  - repository:
      owner: dastrobu
      name: homebrew-tap
      token: "{{ .Env.HOMEBREW_TAP_GITHUB_TOKEN }}"

    commit_author:
      name: goreleaserbot
      email: bot@goreleaser.com

    directory: Formula

    homepage: https://github.com/dastrobu/apple-mail-mcp
    description: "MCP server providing programmatic access to macOS Mail.app"

    license: MIT

    # Only macOS
    dependencies:
      - name: go
        type: build

    test: |
      system "#{bin}/apple-mail-mcp", "--version"

    install: |
      bin.install "apple-mail-mcp"
    
    post_install: |
      # Check if launchd service exists and recreate it after upgrade
      # This preserves all settings (port, host, debug, RunAtLoad) from the existing plist
      plist_path = "#{ENV["HOME"]}/Library/LaunchAgents/com.github.dastrobu.apple-mail-mcp.plist"
      if File.exist?(plist_path)
        # Read the existing plist to extract settings
        plist_content = File.read(plist_path)
        
        # Extract port (default: 8787)
        port = plist_content.match(/--port=(\d+)/)
        port_flag = port ? "--port=#{port[1]}" : ""
        
        # Extract host (default: localhost)
        host = plist_content.match(/--host=([^\s<]+)/)
        host_flag = host ? "--host=#{host[1]}" : ""
        
        # Check if debug is enabled
        has_debug = plist_content.include?("<string>--debug</string>")
        debug_flag = has_debug ? "--debug" : ""
        
        # Check if RunAtLoad is set
        has_run_at_load = plist_content.include?("<key>RunAtLoad</key>")
        run_at_load_flag = has_run_at_load ? "" : "--disable-run-at-load"
        
        # Build command with all flags
        cmd = ["#{bin}/apple-mail-mcp"]
        cmd << port_flag unless port_flag.empty?
        cmd << host_flag unless host_flag.empty?
        cmd << debug_flag unless debug_flag.empty?
        cmd << "launchd"
        cmd << "create"
        cmd << run_at_load_flag unless run_at_load_flag.empty?
        
        # Recreate the service preserving all settings
        system(*cmd.reject(&:empty?))
        
        ohai "Recreated launchd service with updated binary (preserved existing settings)"
      end
    
    caveats: |
      Apple Mail MCP Server has been installed!
      
      âš ï¸  IMPORTANT: For proper automation permissions, you should run this server
      via launchd (not from Terminal directly).
      
      Setup launchd service (recommended):
        apple-mail-mcp launchd create
      
      This will:
        â€¢ Create a launchd service that starts automatically
        â€¢ Grant automation permissions to the binary (not Terminal)
        â€¢ Run on HTTP transport (localhost:8787 by default)
      
      To remove the launchd service:
        apple-mail-mcp launchd remove
      
      Before uninstalling with 'brew uninstall apple-mail-mcp':
        1. Stop and remove the launchd service: apple-mail-mcp launchd remove
        2. Then run: brew uninstall apple-mail-mcp
        3. Optionally remove logs: rm -rf ~/Library/Logs/com.github.dastrobu.apple-mail-mcp/
      
      For more information:
        â€¢ README: https://github.com/dastrobu/apple-mail-mcp#readme
        â€¢ Docs: https://github.com/dastrobu/apple-mail-mcp/tree/main/docs

# Release configuration
release:
  github:
    owner: dastrobu
    name: apple-mail-mcp

  draft: false
  prerelease: auto

  name_template: "v{{ .Version }}"

  # Use GitHub's auto-generated release notes
  # Configure via .github/release.yml
  mode: append

  footer: |
    ---

    ## ðŸ“¦ Installation

    ### Homebrew (Recommended)

    ```bash
    brew tap dastrobu/tap
    brew install apple-mail-mcp
    ```

    ### Binary Download

    Download the appropriate archive for your system:
    - **Intel Mac**: `apple-mail-mcp_{{ .Version }}_darwin_amd64.tar.gz`
    - **Apple Silicon**: `apple-mail-mcp_{{ .Version }}_darwin_arm64.tar.gz`

    Extract and install:
    ```bash
    tar -xzf apple-mail-mcp_{{ .Version }}_darwin_*.tar.gz
    sudo mv apple-mail-mcp /usr/local/bin/
    ```

    ### From Source

    ```bash
    go install github.com/dastrobu/apple-mail-mcp@v{{ .Version }}
    ```

    ## ðŸ“š Documentation

    See the [README](https://github.com/dastrobu/apple-mail-mcp#readme) for usage instructions.

# Changelog - GitHub auto-generates release notes based on .github/release.yml
changelog:
  disable: true
